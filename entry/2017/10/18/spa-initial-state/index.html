<!DOCTYPE html><html><head><meta charSet="utf-8" class="next-head"/><title class="next-head">:-) SPAとInitial State</title><link rel="stylesheet" href="/static/bundle.css" class="next-head"/><link rel="preload" href="/_next/765e7917-296e-4e3e-bbed-8c0516a9d82d/page/post.js" as="script"/><link rel="preload" href="/_next/765e7917-296e-4e3e-bbed-8c0516a9d82d/page/_error.js" as="script"/><link rel="preload" href="/_next/c2d25d0dc0dd422e3a8c5b57ffa79c56/app.js" as="script"/></head><body><div><div id="__next"><div data-reactroot=""><header class="navbar"><div class="navbar-brand"><a class="navbar-item" href="/">:-)</a><div class="navbar-burger burger" data-target="navMenu"><span></span><span></span><span></span></div></div><div class="navbar-menu" id="navMenu"><div class="navbar-end"></div></div></header><section class="hero is-primary"><div class="hero-body"><div class="container"><h1 class="title">SPAとInitial State</h1></div></div></section><section class="section"><div class="container is-fluid"><div class="content"><div><h1>TL;DR</h1>
<ul>
<li>誰か初期状態を持っているのかはっきりする</li>
<li>初期状態が定義されるタイミングを考慮する</li>
</ul>
<p>SPAの鬼門は <code>State</code> 管理であるといって過言はない。</p>
<p>今回は初期状態について現在考えていることをメモする。</p>
<h2>前提</h2>
<ul>
<li>URLはRestとする</li>
<li>ページ内から幾つかのAPIにアクセスする</li>
<li>内部は複数のURLからなるSPAで構成されている</li>
<li>
<p>自分が設けている前提</p>
<ul>
<li>同一URLを表示したときには同一のAPIリクエストが発行されるべきである</li>
<li>または期待される結果が同一である（後述）</li>
</ul>
</li>
<li>
<p>APIリクエストの組み立てに必要な状態</p>
<ul>
<li><code>location.href</code></li>
<li>初期状態</li>
</ul>
</li>
</ul>
<h2>例</h2>
<ul>
<li>
<p><a href="https://www.airbnb.com/s/paris/all">https://www.airbnb.com/s/paris/all</a></p>
<ul>
<li>parisの宿を探す、一覧が出て来る</li>
<li>ただ、このURLには <strong>暗黙的に今日以降</strong> という日付範囲が適応されている</li>
</ul>
</li>
<li>
<p><a href="https://www.airbnb.com/s/paris/all?checkin=2017-10-26&amp;checkout=2017-10-28">https://www.airbnb.com/s/paris/all?checkin=2017-10-26&amp;checkout=2017-10-28</a></p>
<ul>
<li>checkin, checkoutの範囲を指定する</li>
<li>カレンダーに適応した日付の範囲と、その範囲内で検索できた対象の宿が表示される</li>
</ul>
</li>
</ul>
<h2>SPAと状態</h2>
<p>airbnbのようなカレンダーのような絞込みを提供している機能のことを考える。</p>
<ul>
<li>
<p>SPAが初期状態を持つ場合</p>
<ul>
<li>初期状態はJavaScriptがダウンロードされた際に決まる（今回は遅延で初期状態を定義することを除く）</li>
</ul>
</li>
<li>
<p>URLとSPAの状態が乖離する場合を考える</p>
<ul>
<li>カレンダーの操作をしているが確定処理を行っていない</li>
<li>画面には途中経過が表示されている（SPAのstateは更新されている）</li>
</ul>
</li>
<li>
<p>初期状態がURLにあるとする場合</p>
<ul>
<li>SPAに流入しJavaScriptがダウンロードされたタイミングと同一とは限らない</li>
<li>上記の場合、期待しない初期状態からクエリを発行するため期待と矛盾する</li>
</ul>
</li>
</ul>
<h2>状態の整合性を取る</h2>
<ul>
<li>
<p>遷移をした場合に状態の整合性をとるactionを <code>onUpdate</code> に書く場合</p>
<ul>
<li>locationを引数として状態更新のアクションがもう1回Fluxを回る</li>
<li><code>upUpdate</code> で再度整合性チェック、必要があればデータ更新</li>
</ul>
</li>
<li>
<p>不必要なURLとstateの整合性を取るための再帰</p>
<ul>
<li>不採用</li>
</ul>
</li>
</ul>
<h2>考えた選択肢</h2>
<ol>
<li>検索条件をサーバから受け取り、検索条件表示と結果の乖離をなくす</li>
<li>初期状態の定義をURLから生成できるよう、参照する状態の初期化を遅延する</li>
</ol>
<p>reduxの場合、後者の方法はわからなかった。</p>
<h2>まとめ</h2>
<p>日本語難しい。</p>
<p>Happy Hacking!</p>
<p><img src="https://media.giphy.com/media/rSdzP7VZgI80w/giphy.gif" alt="image"/></p></div></div></div></section></div></div><div id="__next-error"></div></div><div><script>
          __NEXT_DATA__ = {"props":{"post":{"data":{"title":"SPAとInitial State","date":"2017-10-18T04:00:00.000Z","permalink":"/entry/2017/10/18/spa-initial-state/","page":"post","_entry":"posts/2017-10-19-spa-initial-state/index.md","name":"index","category":"2017-10-19-spa-initial-state","url":"/entry/2017/10/18/spa-initial-state/"},"content":"# TL;DR\n\n- 誰か初期状態を持っているのかはっきりする\n- 初期状態が定義されるタイミングを考慮する\n\nSPAの鬼門は `State` 管理であるといって過言はない。\n\n今回は初期状態について現在考えていることをメモする。\n\n## 前提\n\n- URLはRestとする\n- ページ内から幾つかのAPIにアクセスする\n- 内部は複数のURLからなるSPAで構成されている\n- 自分が設けている前提\n  - 同一URLを表示したときには同一のAPIリクエストが発行されるべきである\n  - または期待される結果が同一である（後述）\n- APIリクエストの組み立てに必要な状態\n  - `location.href`\n  - 初期状態\n\n## 例\n\n- \u003chttps://www.airbnb.com/s/paris/all\u003e\n  - parisの宿を探す、一覧が出て来る\n  - ただ、このURLには **暗黙的に今日以降** という日付範囲が適応されている\n- \u003chttps://www.airbnb.com/s/paris/all?checkin=2017-10-26\u0026checkout=2017-10-28\u003e\n  - checkin, checkoutの範囲を指定する\n  - カレンダーに適応した日付の範囲と、その範囲内で検索できた対象の宿が表示される\n\n## SPAと状態\n\nairbnbのようなカレンダーのような絞込みを提供している機能のことを考える。\n\n- SPAが初期状態を持つ場合\n  - 初期状態はJavaScriptがダウンロードされた際に決まる（今回は遅延で初期状態を定義することを除く）\n- URLとSPAの状態が乖離する場合を考える\n  - カレンダーの操作をしているが確定処理を行っていない\n  - 画面には途中経過が表示されている（SPAのstateは更新されている）\n- 初期状態がURLにあるとする場合\n  - SPAに流入しJavaScriptがダウンロードされたタイミングと同一とは限らない\n  - 上記の場合、期待しない初期状態からクエリを発行するため期待と矛盾する\n\n## 状態の整合性を取る\n\n- 遷移をした場合に状態の整合性をとるactionを `onUpdate` に書く場合\n  - locationを引数として状態更新のアクションがもう1回Fluxを回る\n  - `upUpdate` で再度整合性チェック、必要があればデータ更新\n- 不必要なURLとstateの整合性を取るための再帰\n  - 不採用\n\n## 考えた選択肢\n\n1. 検索条件をサーバから受け取り、検索条件表示と結果の乖離をなくす\n1. 初期状態の定義をURLから生成できるよう、参照する状態の初期化を遅延する\n\nreduxの場合、後者の方法はわからなかった。\n\n## まとめ\n\n日本語難しい。\n\nHappy Hacking!\n\n![image](https://media.giphy.com/media/rSdzP7VZgI80w/giphy.gif)\n"}},"pathname":"/post","query":{"_entry":"posts/2017-10-19-spa-initial-state/index.md"},"buildId":"765e7917-296e-4e3e-bbed-8c0516a9d82d","buildStats":{"app.js":{"hash":"c2d25d0dc0dd422e3a8c5b57ffa79c56"}},"assetPrefix":"","nextExport":true,"err":null,"chunks":[]}
          module={}
          __NEXT_LOADED_PAGES__ = []
          __NEXT_LOADED_CHUNKS__ = []

          __NEXT_REGISTER_PAGE = function (route, fn) {
            __NEXT_LOADED_PAGES__.push({ route: route, fn: fn })
          }

          __NEXT_REGISTER_CHUNK = function (chunkName, fn) {
            __NEXT_LOADED_CHUNKS__.push({ chunkName: chunkName, fn: fn })
          }
        </script><script async="" id="__NEXT_PAGE__/post" type="text/javascript" src="/_next/765e7917-296e-4e3e-bbed-8c0516a9d82d/page/post.js"></script><script async="" id="__NEXT_PAGE__/_error" type="text/javascript" src="/_next/765e7917-296e-4e3e-bbed-8c0516a9d82d/page/_error.js"></script><div></div><script type="text/javascript" src="/_next/c2d25d0dc0dd422e3a8c5b57ffa79c56/app.js" async=""></script></div></body></html>