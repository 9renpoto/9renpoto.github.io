{"data":{"title":"SPAとInitial State","date":"2017-10-18T04:00:00.000Z","permalink":"/entry/2017/10/18/spa-initial-state/","_entry":"posts/2017-10-19-spa-initial-state/index.md","page":"post","name":"index","category":"2017-10-19-spa-initial-state","url":"/entry/2017/10/18/spa-initial-state/"},"content":{"type":"root","children":[{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"TL;DR","position":{"start":{"line":2,"column":3,"offset":3},"end":{"line":2,"column":8,"offset":8}}}],"position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":8,"offset":8}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"誰か初期状態を持っているのかはっきりする","position":{"start":{"line":4,"column":3,"offset":12},"end":{"line":4,"column":23,"offset":32}}}],"position":{"start":{"line":4,"column":1,"offset":10},"end":{"line":4,"column":23,"offset":32}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"初期状態が定義されるタイミングを考慮する","position":{"start":{"line":5,"column":3,"offset":35},"end":{"line":5,"column":23,"offset":55}}}],"position":{"start":{"line":5,"column":1,"offset":33},"end":{"line":5,"column":23,"offset":55}}},{"type":"text","value":"\n"}],"position":{"start":{"line":4,"column":1,"offset":10},"end":{"line":5,"column":23,"offset":55}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"SPAの鬼門は ","position":{"start":{"line":7,"column":1,"offset":57},"end":{"line":7,"column":9,"offset":65}}},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"State"}],"position":{"start":{"line":7,"column":9,"offset":65},"end":{"line":7,"column":16,"offset":72}}},{"type":"text","value":" 管理であるといって過言はない。","position":{"start":{"line":7,"column":16,"offset":72},"end":{"line":7,"column":32,"offset":88}}}],"position":{"start":{"line":7,"column":1,"offset":57},"end":{"line":7,"column":32,"offset":88}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"今回は初期状態について現在考えていることをメモする。","position":{"start":{"line":9,"column":1,"offset":90},"end":{"line":9,"column":27,"offset":116}}}],"position":{"start":{"line":9,"column":1,"offset":90},"end":{"line":9,"column":27,"offset":116}}},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"前提","position":{"start":{"line":11,"column":4,"offset":121},"end":{"line":11,"column":6,"offset":123}}}],"position":{"start":{"line":11,"column":1,"offset":118},"end":{"line":11,"column":6,"offset":123}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"URLはRestとする","position":{"start":{"line":13,"column":3,"offset":127},"end":{"line":13,"column":14,"offset":138}}}],"position":{"start":{"line":13,"column":1,"offset":125},"end":{"line":13,"column":14,"offset":138}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"ページ内から幾つかのAPIにアクセスする","position":{"start":{"line":14,"column":3,"offset":141},"end":{"line":14,"column":23,"offset":161}}}],"position":{"start":{"line":14,"column":1,"offset":139},"end":{"line":14,"column":23,"offset":161}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"内部は複数のURLからなるSPAで構成されている","position":{"start":{"line":15,"column":3,"offset":164},"end":{"line":15,"column":27,"offset":188}}}],"position":{"start":{"line":15,"column":1,"offset":162},"end":{"line":15,"column":27,"offset":188}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"自分が設けている前提","position":{"start":{"line":16,"column":3,"offset":191},"end":{"line":16,"column":13,"offset":201}}}],"position":{"start":{"line":16,"column":3,"offset":191},"end":{"line":16,"column":13,"offset":201}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"同一URLを表示したときには同一のAPIリクエストが発行されるべきである","position":{"start":{"line":17,"column":5,"offset":206},"end":{"line":17,"column":41,"offset":242}}}],"position":{"start":{"line":17,"column":3,"offset":204},"end":{"line":17,"column":41,"offset":242}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"または期待される結果が同一である（後述）","position":{"start":{"line":18,"column":5,"offset":247},"end":{"line":18,"column":25,"offset":267}}}],"position":{"start":{"line":18,"column":3,"offset":245},"end":{"line":18,"column":25,"offset":267}}},{"type":"text","value":"\n"}],"position":{"start":{"line":17,"column":3,"offset":204},"end":{"line":18,"column":25,"offset":267}}},{"type":"text","value":"\n"}],"position":{"start":{"line":16,"column":1,"offset":189},"end":{"line":18,"column":25,"offset":267}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"APIリクエストの組み立てに必要な状態","position":{"start":{"line":19,"column":3,"offset":270},"end":{"line":19,"column":22,"offset":289}}}],"position":{"start":{"line":19,"column":3,"offset":270},"end":{"line":19,"column":22,"offset":289}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"location.href"}],"position":{"start":{"line":20,"column":5,"offset":294},"end":{"line":20,"column":20,"offset":309}}}],"position":{"start":{"line":20,"column":3,"offset":292},"end":{"line":20,"column":20,"offset":309}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"初期状態","position":{"start":{"line":21,"column":5,"offset":314},"end":{"line":21,"column":9,"offset":318}}}],"position":{"start":{"line":21,"column":3,"offset":312},"end":{"line":21,"column":9,"offset":318}}},{"type":"text","value":"\n"}],"position":{"start":{"line":20,"column":3,"offset":292},"end":{"line":21,"column":9,"offset":318}}},{"type":"text","value":"\n"}],"position":{"start":{"line":19,"column":1,"offset":268},"end":{"line":21,"column":9,"offset":318}}},{"type":"text","value":"\n"}],"position":{"start":{"line":13,"column":1,"offset":125},"end":{"line":21,"column":9,"offset":318}}},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"例","position":{"start":{"line":23,"column":4,"offset":323},"end":{"line":23,"column":5,"offset":324}}}],"position":{"start":{"line":23,"column":1,"offset":320},"end":{"line":23,"column":5,"offset":324}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://www.airbnb.com/s/paris/all"},"children":[{"type":"text","value":"https://www.airbnb.com/s/paris/all","position":{"start":{"line":25,"column":4,"offset":329},"end":{"line":25,"column":38,"offset":363}}}],"position":{"start":{"line":25,"column":3,"offset":328},"end":{"line":25,"column":39,"offset":364}}}],"position":{"start":{"line":25,"column":3,"offset":328},"end":{"line":25,"column":39,"offset":364}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"parisの宿を探す、一覧が出て来る","position":{"start":{"line":26,"column":5,"offset":369},"end":{"line":26,"column":23,"offset":387}}}],"position":{"start":{"line":26,"column":3,"offset":367},"end":{"line":26,"column":23,"offset":387}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"ただ、このURLには ","position":{"start":{"line":27,"column":5,"offset":392},"end":{"line":27,"column":16,"offset":403}}},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"暗黙的に今日以降","position":{"start":{"line":27,"column":18,"offset":405},"end":{"line":27,"column":26,"offset":413}}}],"position":{"start":{"line":27,"column":16,"offset":403},"end":{"line":27,"column":28,"offset":415}}},{"type":"text","value":" という日付範囲が適応されている","position":{"start":{"line":27,"column":28,"offset":415},"end":{"line":27,"column":44,"offset":431}}}],"position":{"start":{"line":27,"column":3,"offset":390},"end":{"line":27,"column":44,"offset":431}}},{"type":"text","value":"\n"}],"position":{"start":{"line":26,"column":3,"offset":367},"end":{"line":27,"column":44,"offset":431}}},{"type":"text","value":"\n"}],"position":{"start":{"line":25,"column":1,"offset":326},"end":{"line":27,"column":44,"offset":431}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://www.airbnb.com/s/paris/all?checkin=2017-10-26&checkout=2017-10-28"},"children":[{"type":"text","value":"https://www.airbnb.com/s/paris/all?checkin=2017-10-26&checkout=2017-10-28","position":{"start":{"line":28,"column":4,"offset":435},"end":{"line":28,"column":77,"offset":508}}}],"position":{"start":{"line":28,"column":3,"offset":434},"end":{"line":28,"column":78,"offset":509}}}],"position":{"start":{"line":28,"column":3,"offset":434},"end":{"line":28,"column":78,"offset":509}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"checkin, checkoutの範囲を指定する","position":{"start":{"line":29,"column":5,"offset":514},"end":{"line":29,"column":30,"offset":539}}}],"position":{"start":{"line":29,"column":3,"offset":512},"end":{"line":29,"column":30,"offset":539}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"カレンダーに適応した日付の範囲と、その範囲内で検索できた対象の宿が表示される","position":{"start":{"line":30,"column":5,"offset":544},"end":{"line":30,"column":43,"offset":582}}}],"position":{"start":{"line":30,"column":3,"offset":542},"end":{"line":30,"column":43,"offset":582}}},{"type":"text","value":"\n"}],"position":{"start":{"line":29,"column":3,"offset":512},"end":{"line":30,"column":43,"offset":582}}},{"type":"text","value":"\n"}],"position":{"start":{"line":28,"column":1,"offset":432},"end":{"line":30,"column":43,"offset":582}}},{"type":"text","value":"\n"}],"position":{"start":{"line":25,"column":1,"offset":326},"end":{"line":30,"column":43,"offset":582}}},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"SPAと状態","position":{"start":{"line":32,"column":4,"offset":587},"end":{"line":32,"column":10,"offset":593}}}],"position":{"start":{"line":32,"column":1,"offset":584},"end":{"line":32,"column":10,"offset":593}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"airbnbのようなカレンダーのような絞込みを提供している機能のことを考える。","position":{"start":{"line":34,"column":1,"offset":595},"end":{"line":34,"column":40,"offset":634}}}],"position":{"start":{"line":34,"column":1,"offset":595},"end":{"line":34,"column":40,"offset":634}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"SPAが初期状態を持つ場合","position":{"start":{"line":36,"column":3,"offset":638},"end":{"line":36,"column":16,"offset":651}}}],"position":{"start":{"line":36,"column":3,"offset":638},"end":{"line":36,"column":16,"offset":651}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"初期状態はJavaScriptがダウンロードされた際に決まる（今回は遅延で初期状態を定義することを除く）","position":{"start":{"line":37,"column":5,"offset":656},"end":{"line":37,"column":57,"offset":708}}}],"position":{"start":{"line":37,"column":3,"offset":654},"end":{"line":37,"column":57,"offset":708}}},{"type":"text","value":"\n"}],"position":{"start":{"line":37,"column":3,"offset":654},"end":{"line":37,"column":57,"offset":708}}},{"type":"text","value":"\n"}],"position":{"start":{"line":36,"column":1,"offset":636},"end":{"line":37,"column":57,"offset":708}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"URLとSPAの状態が乖離する場合を考える","position":{"start":{"line":38,"column":3,"offset":711},"end":{"line":38,"column":24,"offset":732}}}],"position":{"start":{"line":38,"column":3,"offset":711},"end":{"line":38,"column":24,"offset":732}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"カレンダーの操作をしているが確定処理を行っていない","position":{"start":{"line":39,"column":5,"offset":737},"end":{"line":39,"column":30,"offset":762}}}],"position":{"start":{"line":39,"column":3,"offset":735},"end":{"line":39,"column":30,"offset":762}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"画面には途中経過が表示されている（SPAのstateは更新されている）","position":{"start":{"line":40,"column":5,"offset":767},"end":{"line":40,"column":40,"offset":802}}}],"position":{"start":{"line":40,"column":3,"offset":765},"end":{"line":40,"column":40,"offset":802}}},{"type":"text","value":"\n"}],"position":{"start":{"line":39,"column":3,"offset":735},"end":{"line":40,"column":40,"offset":802}}},{"type":"text","value":"\n"}],"position":{"start":{"line":38,"column":1,"offset":709},"end":{"line":40,"column":40,"offset":802}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"初期状態がURLにあるとする場合","position":{"start":{"line":41,"column":3,"offset":805},"end":{"line":41,"column":19,"offset":821}}}],"position":{"start":{"line":41,"column":3,"offset":805},"end":{"line":41,"column":19,"offset":821}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"SPAに流入しJavaScriptがダウンロードされたタイミングと同一とは限らない","position":{"start":{"line":42,"column":5,"offset":826},"end":{"line":42,"column":46,"offset":867}}}],"position":{"start":{"line":42,"column":3,"offset":824},"end":{"line":42,"column":46,"offset":867}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"上記の場合、期待しない初期状態からクエリを発行するため期待と矛盾する","position":{"start":{"line":43,"column":5,"offset":872},"end":{"line":43,"column":39,"offset":906}}}],"position":{"start":{"line":43,"column":3,"offset":870},"end":{"line":43,"column":39,"offset":906}}},{"type":"text","value":"\n"}],"position":{"start":{"line":42,"column":3,"offset":824},"end":{"line":43,"column":39,"offset":906}}},{"type":"text","value":"\n"}],"position":{"start":{"line":41,"column":1,"offset":803},"end":{"line":43,"column":39,"offset":906}}},{"type":"text","value":"\n"}],"position":{"start":{"line":36,"column":1,"offset":636},"end":{"line":43,"column":39,"offset":906}}},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"状態の整合性を取る","position":{"start":{"line":45,"column":4,"offset":911},"end":{"line":45,"column":13,"offset":920}}}],"position":{"start":{"line":45,"column":1,"offset":908},"end":{"line":45,"column":13,"offset":920}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"遷移をした場合に状態の整合性をとるactionを ","position":{"start":{"line":47,"column":3,"offset":924},"end":{"line":47,"column":28,"offset":949}}},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"onUpdate"}],"position":{"start":{"line":47,"column":28,"offset":949},"end":{"line":47,"column":38,"offset":959}}},{"type":"text","value":" に書く場合","position":{"start":{"line":47,"column":38,"offset":959},"end":{"line":47,"column":44,"offset":965}}}],"position":{"start":{"line":47,"column":3,"offset":924},"end":{"line":47,"column":44,"offset":965}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"locationを引数として状態更新のアクションがもう1回Fluxを回る","position":{"start":{"line":48,"column":5,"offset":970},"end":{"line":48,"column":41,"offset":1006}}}],"position":{"start":{"line":48,"column":3,"offset":968},"end":{"line":48,"column":41,"offset":1006}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"onUpdate"}],"position":{"start":{"line":49,"column":5,"offset":1011},"end":{"line":49,"column":15,"offset":1021}}},{"type":"text","value":" で再度整合性チェック、必要があればデータ更新","position":{"start":{"line":49,"column":15,"offset":1021},"end":{"line":49,"column":38,"offset":1044}}}],"position":{"start":{"line":49,"column":3,"offset":1009},"end":{"line":49,"column":38,"offset":1044}}},{"type":"text","value":"\n"}],"position":{"start":{"line":48,"column":3,"offset":968},"end":{"line":49,"column":38,"offset":1044}}},{"type":"text","value":"\n"}],"position":{"start":{"line":47,"column":1,"offset":922},"end":{"line":49,"column":38,"offset":1044}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"不必要なURLとstateの整合性を取るための再帰","position":{"start":{"line":50,"column":3,"offset":1047},"end":{"line":50,"column":28,"offset":1072}}}],"position":{"start":{"line":50,"column":3,"offset":1047},"end":{"line":50,"column":28,"offset":1072}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"不採用","position":{"start":{"line":51,"column":5,"offset":1077},"end":{"line":51,"column":8,"offset":1080}}}],"position":{"start":{"line":51,"column":3,"offset":1075},"end":{"line":51,"column":8,"offset":1080}}},{"type":"text","value":"\n"}],"position":{"start":{"line":51,"column":3,"offset":1075},"end":{"line":51,"column":8,"offset":1080}}},{"type":"text","value":"\n"}],"position":{"start":{"line":50,"column":1,"offset":1045},"end":{"line":51,"column":8,"offset":1080}}},{"type":"text","value":"\n"}],"position":{"start":{"line":47,"column":1,"offset":922},"end":{"line":51,"column":8,"offset":1080}}},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"考えた選択肢","position":{"start":{"line":53,"column":4,"offset":1085},"end":{"line":53,"column":10,"offset":1091}}}],"position":{"start":{"line":53,"column":1,"offset":1082},"end":{"line":53,"column":10,"offset":1091}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"検索条件をサーバから受け取り、検索条件表示と結果の乖離をなくす","position":{"start":{"line":55,"column":5,"offset":1097},"end":{"line":55,"column":36,"offset":1128}}}],"position":{"start":{"line":55,"column":1,"offset":1093},"end":{"line":55,"column":36,"offset":1128}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"初期状態の定義をURLから生成できるよう、参照する状態の初期化を遅延する","position":{"start":{"line":56,"column":5,"offset":1133},"end":{"line":56,"column":41,"offset":1169}}}],"position":{"start":{"line":56,"column":1,"offset":1129},"end":{"line":56,"column":41,"offset":1169}}},{"type":"text","value":"\n"}],"position":{"start":{"line":55,"column":1,"offset":1093},"end":{"line":56,"column":41,"offset":1169}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"reduxの場合、後者の方法はわからなかった。","position":{"start":{"line":58,"column":1,"offset":1171},"end":{"line":58,"column":24,"offset":1194}}}],"position":{"start":{"line":58,"column":1,"offset":1171},"end":{"line":58,"column":24,"offset":1194}}},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"まとめ","position":{"start":{"line":60,"column":4,"offset":1199},"end":{"line":60,"column":7,"offset":1202}}}],"position":{"start":{"line":60,"column":1,"offset":1196},"end":{"line":60,"column":7,"offset":1202}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"日本語難しい。","position":{"start":{"line":62,"column":1,"offset":1204},"end":{"line":62,"column":8,"offset":1211}}}],"position":{"start":{"line":62,"column":1,"offset":1204},"end":{"line":62,"column":8,"offset":1211}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Happy Hacking!","position":{"start":{"line":64,"column":1,"offset":1213},"end":{"line":64,"column":15,"offset":1227}}}],"position":{"start":{"line":64,"column":1,"offset":1213},"end":{"line":64,"column":15,"offset":1227}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"img","properties":{"src":"https://media.giphy.com/media/rSdzP7VZgI80w/giphy.gif","alt":"image"},"children":[],"position":{"start":{"line":66,"column":1,"offset":1229},"end":{"line":66,"column":64,"offset":1292}}}],"position":{"start":{"line":66,"column":1,"offset":1229},"end":{"line":66,"column":64,"offset":1292}}}],"data":{"quirksMode":false},"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":1,"column":1,"offset":0}}},"raw":"\n# TL;DR\n\n* 誰か初期状態を持っているのかはっきりする\n* 初期状態が定義されるタイミングを考慮する\n\nSPAの鬼門は `State` 管理であるといって過言はない。\n\n今回は初期状態について現在考えていることをメモする。\n\n## 前提\n\n* URLはRestとする\n* ページ内から幾つかのAPIにアクセスする\n* 内部は複数のURLからなるSPAで構成されている\n* 自分が設けている前提\n  * 同一URLを表示したときには同一のAPIリクエストが発行されるべきである\n  * または期待される結果が同一である（後述）\n* APIリクエストの組み立てに必要な状態\n  * `location.href`\n  * 初期状態\n\n## 例\n\n* <https://www.airbnb.com/s/paris/all>\n  * parisの宿を探す、一覧が出て来る\n  * ただ、このURLには **暗黙的に今日以降** という日付範囲が適応されている\n* <https://www.airbnb.com/s/paris/all?checkin=2017-10-26&checkout=2017-10-28>\n  * checkin, checkoutの範囲を指定する\n  * カレンダーに適応した日付の範囲と、その範囲内で検索できた対象の宿が表示される\n\n## SPAと状態\n\nairbnbのようなカレンダーのような絞込みを提供している機能のことを考える。\n\n* SPAが初期状態を持つ場合\n  * 初期状態はJavaScriptがダウンロードされた際に決まる（今回は遅延で初期状態を定義することを除く）\n* URLとSPAの状態が乖離する場合を考える\n  * カレンダーの操作をしているが確定処理を行っていない\n  * 画面には途中経過が表示されている（SPAのstateは更新されている）\n* 初期状態がURLにあるとする場合\n  * SPAに流入しJavaScriptがダウンロードされたタイミングと同一とは限らない\n  * 上記の場合、期待しない初期状態からクエリを発行するため期待と矛盾する\n\n## 状態の整合性を取る\n\n* 遷移をした場合に状態の整合性をとるactionを `onUpdate` に書く場合\n  * locationを引数として状態更新のアクションがもう1回Fluxを回る\n  * `onUpdate` で再度整合性チェック、必要があればデータ更新\n* 不必要なURLとstateの整合性を取るための再帰\n  * 不採用\n\n## 考えた選択肢\n\n1.  検索条件をサーバから受け取り、検索条件表示と結果の乖離をなくす\n1.  初期状態の定義をURLから生成できるよう、参照する状態の初期化を遅延する\n\nreduxの場合、後者の方法はわからなかった。\n\n## まとめ\n\n日本語難しい。\n\nHappy Hacking!\n\n![image](https://media.giphy.com/media/rSdzP7VZgI80w/giphy.gif)\n"}