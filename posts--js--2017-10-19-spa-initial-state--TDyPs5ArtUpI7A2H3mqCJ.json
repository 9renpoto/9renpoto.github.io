{"data":{"title":"SPAとInitial State","date":"2017-10-18T04:00:00.000Z","permalink":"/entry/2017/10/18/spa-initial-state/","category":"react","_entry":"posts/js/2017-10-19-spa-initial-state.md","page":"post","name":"spa-initial-state","url":"/entry/2017/10/18/spa-initial-state/"},"content":{"type":"root","children":[{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"TL;DR"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"誰か初期状態を持っているのかはっきりする"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"初期状態が定義されるタイミングを考慮する"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"SPAの鬼門は "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"State"}]},{"type":"text","value":" 管理であるといって過言はない。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"今回は初期状態について現在考えていることをメモする。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"前提"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"URLはRestとする"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"ページ内から幾つかのAPIにアクセスする"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"内部は複数のURLからなるSPAで構成されている"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"自分が設けている前提"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"同一URLを表示したときには同一のAPIリクエストが発行されるべきである"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"または期待される結果が同一である（後述）"}]},{"type":"text","value":"\n"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"APIリクエストの組み立てに必要な状態"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"location.href"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"初期状態"}]},{"type":"text","value":"\n"}]}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"例"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://www.airbnb.com/s/paris/all"},"children":[{"type":"text","value":"https://www.airbnb.com/s/paris/all"}]},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"parisの宿を探す、一覧が出て来る"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"ただ、このURLには "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"暗黙的に今日以降"}]},{"type":"text","value":" という日付範囲が適応されている"}]},{"type":"text","value":"\n"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://www.airbnb.com/s/paris/all?checkin=2017-10-26&checkout=2017-10-28"},"children":[{"type":"text","value":"https://www.airbnb.com/s/paris/all?checkin=2017-10-26&checkout=2017-10-28"}]},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"checkin, checkoutの範囲を指定する"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"カレンダーに適応した日付の範囲と、その範囲内で検索できた対象の宿が表示される"}]},{"type":"text","value":"\n"}]}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"SPAと状態"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"airbnbのようなカレンダーのような絞込みを提供している機能のことを考える。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"SPAが初期状態を持つ場合"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"初期状態はJavaScriptがダウンロードされた際に決まる（今回は遅延で初期状態を定義することを除く）"}]},{"type":"text","value":"\n"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"URLとSPAの状態が乖離する場合を考える"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"カレンダーの操作をしているが確定処理を行っていない"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"画面には途中経過が表示されている（SPAのstateは更新されている）"}]},{"type":"text","value":"\n"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"初期状態がURLにあるとする場合"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"SPAに流入しJavaScriptがダウンロードされたタイミングと同一とは限らない"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"上記の場合、期待しない初期状態からクエリを発行するため期待と矛盾する"}]},{"type":"text","value":"\n"}]}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"状態の整合性を取る"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"遷移をした場合に状態の整合性をとるactionを "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"onUpdate"}]},{"type":"text","value":" に書く場合"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"locationを引数として状態更新のアクションがもう1回Fluxを回る"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"onUpdate"}]},{"type":"text","value":" で再度整合性チェック、必要があればデータ更新"}]},{"type":"text","value":"\n"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"不必要なURLとstateの整合性を取るための再帰"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"不採用"}]},{"type":"text","value":"\n"}]}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"考えた選択肢"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"検索条件をサーバから受け取り、検索条件表示と結果の乖離をなくす"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"初期状態の定義をURLから生成できるよう、参照する状態の初期化を遅延する"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"reduxの場合、後者の方法はわからなかった。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"まとめ"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"日本語難しい。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Happy Hacking!"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"img","properties":{"src":"https://media.giphy.com/media/rSdzP7VZgI80w/giphy.gif","alt":"image"},"children":[]}]}],"data":{"quirksMode":false}},"raw":"\n# TL;DR\n\n- 誰か初期状態を持っているのかはっきりする\n- 初期状態が定義されるタイミングを考慮する\n\nSPAの鬼門は `State` 管理であるといって過言はない。\n\n今回は初期状態について現在考えていることをメモする。\n\n## 前提\n\n- URLはRestとする\n- ページ内から幾つかのAPIにアクセスする\n- 内部は複数のURLからなるSPAで構成されている\n- 自分が設けている前提\n  - 同一URLを表示したときには同一のAPIリクエストが発行されるべきである\n  - または期待される結果が同一である（後述）\n- APIリクエストの組み立てに必要な状態\n  - `location.href`\n  - 初期状態\n\n## 例\n\n- <https://www.airbnb.com/s/paris/all>\n  - parisの宿を探す、一覧が出て来る\n  - ただ、このURLには **暗黙的に今日以降** という日付範囲が適応されている\n- <https://www.airbnb.com/s/paris/all?checkin=2017-10-26&checkout=2017-10-28>\n  - checkin, checkoutの範囲を指定する\n  - カレンダーに適応した日付の範囲と、その範囲内で検索できた対象の宿が表示される\n\n## SPAと状態\n\nairbnbのようなカレンダーのような絞込みを提供している機能のことを考える。\n\n- SPAが初期状態を持つ場合\n  - 初期状態はJavaScriptがダウンロードされた際に決まる（今回は遅延で初期状態を定義することを除く）\n- URLとSPAの状態が乖離する場合を考える\n  - カレンダーの操作をしているが確定処理を行っていない\n  - 画面には途中経過が表示されている（SPAのstateは更新されている）\n- 初期状態がURLにあるとする場合\n  - SPAに流入しJavaScriptがダウンロードされたタイミングと同一とは限らない\n  - 上記の場合、期待しない初期状態からクエリを発行するため期待と矛盾する\n\n## 状態の整合性を取る\n\n- 遷移をした場合に状態の整合性をとるactionを `onUpdate` に書く場合\n  - locationを引数として状態更新のアクションがもう1回Fluxを回る\n  - `onUpdate` で再度整合性チェック、必要があればデータ更新\n- 不必要なURLとstateの整合性を取るための再帰\n  - 不採用\n\n## 考えた選択肢\n\n1.  検索条件をサーバから受け取り、検索条件表示と結果の乖離をなくす\n1.  初期状態の定義をURLから生成できるよう、参照する状態の初期化を遅延する\n\nreduxの場合、後者の方法はわからなかった。\n\n## まとめ\n\n日本語難しい。\n\nHappy Hacking!\n\n![image](https://media.giphy.com/media/rSdzP7VZgI80w/giphy.gif)\n"}